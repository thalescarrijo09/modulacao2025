<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Professores de EF - Mineiros GO</title>
    <!-- Inclui Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }
        .sidebar {
            width: 250px;
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1.5rem 1rem;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-top-right-radius: 1rem;
            border-bottom-right-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .main-content {
            margin-left: 250px;
            padding: 1.5rem;
            flex-grow: 1;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-radius: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar-nav {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: border-color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f3f4f6;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row">
    <!-- Barra de navegação lateral -->
    <div class="sidebar">
        <div class="flex items-center justify-center mb-10">
            <svg class="w-10 h-10 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM10 16.5l-4-4 1.41-1.41L10 13.67l6.59-6.59L18 8l-8 8.5z"/>
            </svg>
            <span class="ml-3 text-xl font-bold">Gestão EF</span>
        </div>
        <nav class="sidebar-nav space-y-2">
            <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors" data-view="dashboard">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors" data-view="manage-lessons">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span>Gestão de Aulas</span>
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors" data-view="manage-schools">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>
                <span>Gestão de Escolas</span>
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors" data-view="manage-teachers">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span>Gestão de Professores</span>
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors" data-view="reports">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1012.945 3M10 14l3-3m-3 0l3 3m-3-3l3 3m-3-3L8 8l3 3z"></path></svg>
                <span>Relatórios</span>
            </a>
            <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition-colors" data-view="import">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>Importar Dados</span>
            </a>
        </nav>
        <!-- Simula a troca de perfil para o modo de visualização -->
        <div class="mt-auto pt-6 border-t border-gray-700">
            <label for="role-switch" class="flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="role-switch" class="sr-only">
                    <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform"></div>
                </div>
                <div class="ml-3 text-sm">
                    Modo de Visualização (Gestor)
                </div>
            </label>
        </div>
    </div>

    <!-- Conteúdo principal -->
    <div id="main-content" class="main-content">
        <!-- O conteúdo será carregado aqui dinamicamente -->
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
        <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Aulas Totais</p>
                <p id="total-aulas-card" class="text-4xl font-bold text-gray-900 mt-2">0</p>
            </div>
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Aulas Sem Professor</p>
                <p id="aulas-sem-prof-card" class="text-4xl font-bold text-red-500 mt-2">0</p>
            </div>
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Professores Ativos</p>
                <p id="professores-ativos-card" class="text-4xl font-bold text-gray-900 mt-2">0</p>
            </div>
            <div class="card text-center">
                <p class="text-gray-500 text-sm">Carga Horária Média</p>
                <p id="carga-horaria-media-card" class="text-4xl font-bold text-gray-900 mt-2">0</p>
            </div>
        </div>

        <div id="loading-message" class="text-center text-lg text-gray-600 my-10 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
            <p class="mt-2">Carregando dados...</p>
        </div>

        <div id="content-views">
            <!-- As views de Dashboard, Gestão, Relatórios e Importação serão renderizadas aqui -->
        </div>
    </div>

    <!-- Modal de confirmação para exclusão -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Tem certeza de que deseja excluir este item?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-delete-btn" class="btn bg-red-500 text-white hover:bg-red-600">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, deleteDoc, updateDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis globais de ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Suas credenciais do Firebase, fornecidas pelo usuário
        const firebaseConfig = {
            apiKey: "AIzaSyBPV-BbwYNHnZEh11fWHyI4ugywcOK7sN4",
            authDomain: "gestaoef-e7eb3.firebaseapp.com",
            projectId: "gestaoef-e7eb3",
            storageBucket: "gestaoef-e7eb3.firebasestorage.app",
            messagingSenderId: "36441566692",
            appId: "1:36441566692:web:bc1f42bfc1c84a25d9ebf1",
        };
        
        // Listas de escolas e professores fornecidas pelo usuário
        const schoolsToImport = [
            'CMEI Sebastiana Flores',
            'Escola Municipal Castelo Branco',
            'Escola Municipal Comecinho de Vida',
            'Escola Municipal Dom Bosco',
            'Escola Municipal Elias Carrijo',
            'Escola Municipal Maria Aparecida Paniago',
            'Escola Municipal Mª Eduarda C. Filgueiras',
            'Escola Municipal Otalécio Alves Irineu',
            'Escola Municipal Pe Maximíno Alvarez Gutierrez',
            'Escola Municipal Prof. Salviano Neves Amorim',
            'Escola Municipal Professor Juarêz Távora',
            'Escola Municipal Reverendo Eudóxio',
            'Escola Municipal Santo Antônio',
            'Escola Municipal Tonico Corredeira'
        ];

        const teachersToImport = [
            'Alberto Teles',
            'Ana Mireile',
            'Ana Paula',
            'Cristiane Alves',
            'Cristiane Pereira',
            'Daiana Rodrigues',
            'Domingos Savio',
            'Fernando Shoenberger',
            'Hugo Sergio',
            'Lindonei Barbosa',
            'Lorena da Silva',
            'Poliane Matos'
        ];


        let db, auth;
        let userId;
        let isAuthReady = false;
        let canEdit = true; // Simula a permissão de edição

        // Mapeamento de coleções com o ID da aplicação
        const collections = {
            lessons: `artifacts/${appId}/public/data/lessons`,
            schools: `artifacts/${appId}/public/data/schools`,
            teachers: `artifacts/${appId}/public/data/teachers`,
            classes: `artifacts/${appId}/public/data/classes`,
        };

        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const modalMessage = document.getElementById('modal-message');

        let pendingDeleteInfo = null;

        // Funções para manipulação do modal
        function showConfirmModal(message, docRef) {
            modalMessage.textContent = message;
            pendingDeleteInfo = docRef;
            confirmModal.classList.add('visible');
        }

        function hideConfirmModal() {
            confirmModal.classList.remove('visible');
            pendingDeleteInfo = null;
        }

        cancelDeleteBtn.onclick = hideConfirmModal;
        confirmDeleteBtn.onclick = async () => {
            if (!db || !isAuthReady) {
                showMessage('O sistema não está pronto. Tente novamente em alguns segundos.', 'error');
                hideConfirmModal();
                return;
            }
            if (pendingDeleteInfo) {
                const { collectionName, docId } = pendingDeleteInfo;
                if (!canEdit) {
                    showMessage('Você não tem permissão para excluir itens.', 'error');
                    hideConfirmModal();
                    return;
                }
                try {
                    const docRef = doc(db, collectionName, docId);
                    await deleteDoc(docRef);
                    showMessage('Item excluído com sucesso!', 'success');
                } catch (error) {
                    console.error("Erro ao excluir documento: ", error);
                    showMessage('Erro ao excluir item. Tente novamente.', 'error');
                } finally {
                    hideConfirmModal();
                }
            }
        };

        // Função de inicialização do Firebase e autenticação
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.error("Firebase config is missing or invalid. Please provide a valid configuration.");
                    document.getElementById('loading-message').textContent = 'Erro de configuração do Firebase. Verifique o console para mais detalhes.';
                    return;
                }

                // Initialize the app with your provided config
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Habilita a persistência de dados localmente.
                try {
                    await enableIndexedDbPersistence(db);
                    console.log("Persistência offline habilitada com sucesso.");
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        console.warn("Múltiplas abas estão usando o aplicativo, persistência não habilitada.");
                    } else if (err.code === 'unimplemented') {
                        console.warn("O navegador não suporta persistência offline.");
                    } else {
                        console.error("Erro ao habilitar persistência offline:", err);
                    }
                }

                // Autenticação robusta: Tenta a autenticação anônima e aguarda o resultado
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Autenticação bem-sucedida. UID:", userId);
                        
                        // Populando o banco de dados se as coleções estiverem vazias
                        await populateInitialData();

                        await setupRealtimeListeners();
                        renderView(document.querySelector('.nav-item.active')?.dataset.view || 'dashboard');
                        document.getElementById('loading-message').classList.add('hidden');
                    } else {
                        isAuthReady = false;
                        console.error("Falha na autenticação. O aplicativo não pode ser carregado sem um usuário autenticado.");
                        showMessage("Falha na autenticação. O aplicativo não pode ser carregado.", 'error');
                        document.getElementById('loading-message').classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                document.getElementById('loading-message').textContent = 'Erro ao carregar o aplicativo. Verifique o console para mais detalhes.';
            }
        }
        
        // Função para popular o banco de dados com dados iniciais
        async function populateInitialData() {
            const schoolsCollection = collection(db, collections.schools);
            const teachersCollection = collection(db, collections.teachers);
            
            // Verifica se a coleção de escolas está vazia
            const schoolsSnapshot = await getDocs(schoolsCollection);
            if (schoolsSnapshot.empty) {
                console.log("Iniciando a importação de escolas...");
                for (const schoolName of schoolsToImport) {
                    await addDoc(schoolsCollection, { name: schoolName });
                }
                console.log("Escolas importadas com sucesso.");
            }
            
            // Verifica se a coleção de professores está vazia
            const teachersSnapshot = await getDocs(teachersCollection);
            if (teachersSnapshot.empty) {
                console.log("Iniciando a importação de professores...");
                for (const teacherName of teachersToImport) {
                    await addDoc(teachersCollection, { name: teacherName });
                }
                console.log("Professores importados com sucesso.");
            }
        }

        // Função para mostrar mensagens de feedback
        function showMessage(text, type = 'info') {
            const container = document.getElementById('main-content');
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            messageDiv.className = `p-4 my-4 rounded-lg text-white shadow-md transition-all duration-300 transform scale-y-0 opacity-0 origin-top`;
            if (type === 'success') {
                messageDiv.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-500');
            } else {
                messageDiv.classList.add('bg-blue-500');
            }
            container.prepend(messageDiv);
            setTimeout(() => {
                messageDiv.classList.remove('scale-y-0', 'opacity-0');
            }, 50);
            setTimeout(() => {
                messageDiv.classList.add('scale-y-0', 'opacity-0');
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // Simula o controle de acesso por permissão
        const roleSwitch = document.getElementById('role-switch');
        roleSwitch.addEventListener('change', (e) => {
            canEdit = !e.target.checked;
            document.getElementById('main-content').classList.toggle('view-only', !canEdit);
            showMessage(e.target.checked ? 'Modo de visualização ativado. Funções de edição desabilitadas.' : 'Modo de edição ativado. Todas as funcionalidades estão disponíveis.', 'info');
            renderView(document.querySelector('.nav-item.active')?.dataset.view || 'dashboard');
        });

        // ------------------ Funções de Roteamento e Renderização de Conteúdo ------------------
        const contentViews = document.getElementById('content-views');
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active', 'bg-gray-700'));
                item.classList.add('active', 'bg-gray-700');
                const view = item.dataset.view;
                renderView(view);
            });
        });

        function renderView(view) {
            document.querySelectorAll('h1').forEach(h1 => h1.remove());
            const title = document.createElement('h1');
            title.className = "text-3xl font-bold text-gray-800 mb-6";
            document.getElementById('main-content').prepend(title);
            contentViews.innerHTML = ''; // Limpa o conteúdo
            document.getElementById('dashboard-content').classList.add('hidden'); // Oculta o dashboard por padrão

            switch (view) {
                case 'dashboard':
                    title.textContent = 'Dashboard';
                    document.getElementById('dashboard-content').classList.remove('hidden');
                    updateDashboard();
                    break;
                case 'manage-lessons':
                    title.textContent = 'Gestão de Aulas';
                    renderLessonsView();
                    break;
                case 'manage-schools':
                    title.textContent = 'Gestão de Escolas';
                    renderSchoolsView();
                    break;
                case 'manage-teachers':
                    title.textContent = 'Gestão de Professores';
                    renderTeachersView();
                    break;
                case 'reports':
                    title.textContent = 'Relatórios';
                    renderReportsView();
                    break;
                case 'import':
                    title.textContent = 'Importar Dados';
                    renderImportView();
                    break;
            }
        }

        // ------------------ Funções para o Dashboard ------------------
        let allLessons = [];
        let allTeachers = [];
        let allSchools = [];

        function updateDashboard() {
            const totalAulas = allLessons.length;
            const aulasSemProfessor = allLessons.filter(lesson => !lesson.teacherName || lesson.teacherName.trim() === "").length;
            const professoresAtivos = allTeachers.length;
            
            const aulasPorProfessor = allTeachers.reduce((acc, teacher) => {
                const count = allLessons.filter(lesson => lesson.teacherName === teacher.name).length;
                acc[teacher.name] = count;
                return acc;
            }, {});

            const totalLessonsCount = Object.values(aulasPorProfessor).reduce((sum, count) => sum + count, 0);
            const averageWorkload = professoresAtivos > 0 ? (totalLessonsCount / professoresAtivos).toFixed(1) : 0;

            document.getElementById('total-aulas-card').textContent = totalAulas;
            document.getElementById('aulas-sem-prof-card').textContent = aulasSemProfessor;
            document.getElementById('professores-ativos-card').textContent = professoresAtivos;
            document.getElementById('carga-horaria-media-card').textContent = averageWorkload;
        }

        // ------------------ Funções para a Gestão de Aulas ------------------
        let currentEditingLessonId = null;

        function renderLessonsView() {
            contentViews.innerHTML = `
                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Adicionar/Editar Aula</h2>
                    <form id="lesson-form" class="space-y-4">
                        <div>
                            <label for="school" class="block text-sm font-medium text-gray-700">Escola</label>
                            <select id="school" name="school" class="input-field mt-1" required>
                                <option value="">Selecione a Escola</option>
                            </select>
                        </div>
                        <div>
                            <label for="shift" class="block text-sm font-medium text-gray-700">Turno</label>
                            <select id="shift" name="shift" class="input-field mt-1" required>
                                <option value="">Selecione o Turno</option>
                                <option value="MATUTINO">MATUTINO</option>
                                <option value="VESPERTINO">VESPERTINO</option>
                            </select>
                        </div>
                        <div>
                            <label for="class" class="block text-sm font-medium text-gray-700">Turma</label>
                            <input type="text" id="class" name="class" class="input-field mt-1" placeholder="Ex: 1º Ano, Jardim I" required>
                        </div>
                        <div>
                            <label for="num-lessons" class="block text-sm font-medium text-gray-700">Nº de Aulas</label>
                            <input type="number" id="num-lessons" name="num-lessons" class="input-field mt-1" min="1" value="1" required>
                        </div>
                        <div>
                            <label for="teacher" class="block text-sm font-medium text-gray-700">Professor</label>
                            <select id="teacher" name="teacher" class="input-field mt-1">
                                <option value="">Nenhum</option>
                            </select>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" id="submit-btn" class="btn btn-primary w-full">Adicionar Aula</button>
                            <button type="button" id="cancel-edit-btn" class="btn btn-secondary w-full hidden">Cancelar Edição</button>
                        </div>
                    </form>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Aulas Cadastradas</h2>
                    <div class="flex space-x-4 mb-4">
                        <input type="text" id="filter-text" placeholder="Filtrar por escola, turma ou professor" class="input-field flex-grow">
                        <select id="filter-school" class="input-field w-1/4">
                            <option value="">Filtrar por Escola</option>
                        </select>
                        <select id="filter-teacher" class="input-field w-1/4">
                            <option value="">Filtrar por Professor</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3">Escola</th>
                                    <th class="py-3">Turno</th>
                                    <th class="py-3">Turma</th>
                                    <th class="py-3">Nº Aulas</th>
                                    <th class="py-3">Professor</th>
                                    <th class="py-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lessons-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            setupLessonsListeners();
            populateLessonsFormOptions();
            displayLessons(allLessons);
        }

        function populateLessonsFormOptions() {
            const schoolsSelect = document.getElementById('school');
            const teachersSelect = document.getElementById('teacher');
            const filterSchoolsSelect = document.getElementById('filter-school');
            const filterTeachersSelect = document.getElementById('filter-teacher');

            if (!schoolsSelect || !teachersSelect || !filterSchoolsSelect || !filterTeachersSelect) return;

            // Limpa as opções existentes
            schoolsSelect.innerHTML = '<option value="">Selecione a Escola</option>';
            teachersSelect.innerHTML = '<option value="">Nenhum</option>';
            filterSchoolsSelect.innerHTML = '<option value="">Filtrar por Escola</option>';
            filterTeachersSelect.innerHTML = '<option value="">Filtrar por Professor</option>';

            allSchools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.name;
                option.textContent = school.name;
                schoolsSelect.appendChild(option);
                filterSchoolsSelect.appendChild(option.cloneNode(true));
            });

            allTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                teachersSelect.appendChild(option);
                filterTeachersSelect.appendChild(option.cloneNode(true));
            });
        }

        function setupLessonsListeners() {
            const lessonForm = document.getElementById('lesson-form');
            const submitBtn = document.getElementById('submit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const lessonsTableBody = document.getElementById('lessons-table-body');
            const filterText = document.getElementById('filter-text');
            const filterSchool = document.getElementById('filter-school');
            const filterTeacher = document.getElementById('filter-teacher');
            
            if (!lessonForm || !lessonsTableBody || !filterText || !filterSchool || !filterTeacher) return;

            lessonForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db || !isAuthReady) {
                    showMessage('O sistema não está pronto. Tente novamente em alguns segundos.', 'error');
                    return;
                }
                if (!canEdit) {
                    showMessage('Você não tem permissão para adicionar/editar itens.', 'error');
                    return;
                }
                const formData = new FormData(lessonForm);
                const lessonData = {
                    schoolName: formData.get('school'),
                    shift: formData.get('shift'),
                    className: formData.get('class'),
                    numLessons: parseInt(formData.get('num-lessons')),
                    teacherName: formData.get('teacher') || '',
                    lessonTime: '', // Campo de horário não especificado, mas será incluído para consistência
                };

                try {
                    if (currentEditingLessonId) {
                        const lessonRef = doc(db, collections.lessons, currentEditingLessonId);
                        await updateDoc(lessonRef, lessonData);
                        showMessage('Aula atualizada com sucesso!', 'success');
                    } else {
                        await addDoc(collection(db, collections.lessons), lessonData);
                        showMessage('Aula adicionada com sucesso!', 'success');
                    }
                    lessonForm.reset();
                    currentEditingLessonId = null;
                    submitBtn.textContent = 'Adicionar Aula';
                    cancelEditBtn.classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao salvar aula: ", error);
                    showMessage('Erro ao salvar aula. Tente novamente.', 'error');
                }
            });

            cancelEditBtn.addEventListener('click', () => {
                lessonForm.reset();
                currentEditingLessonId = null;
                submitBtn.textContent = 'Adicionar Aula';
                cancelEditBtn.classList.add('hidden');
            });

            lessonsTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const lessonId = e.target.dataset.id;
                    const lesson = allLessons.find(l => l.id === lessonId);
                    if (lesson) {
                        document.getElementById('school').value = lesson.schoolName;
                        document.getElementById('shift').value = lesson.shift;
                        document.getElementById('class').value = lesson.className;
                        document.getElementById('num-lessons').value = lesson.numLessons;
                        document.getElementById('teacher').value = lesson.teacherName;
                        currentEditingLessonId = lessonId;
                        submitBtn.textContent = 'Salvar Alterações';
                        cancelEditBtn.classList.remove('hidden');
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    const lessonId = e.target.dataset.id;
                    showConfirmModal('Tem certeza que deseja excluir esta aula? Esta ação não pode ser desfeita.', {
                        collectionName: collections.lessons,
                        docId: lessonId
                    });
                }
            });

            const filterLessons = () => {
                const searchText = filterText.value.toLowerCase();
                const selectedSchool = filterSchool.value;
                const selectedTeacher = filterTeacher.value;
                
                const filteredLessons = allLessons.filter(lesson => {
                    const textMatch = searchText === '' || 
                                    (lesson.schoolName && lesson.schoolName.toLowerCase().includes(searchText)) ||
                                    (lesson.className && lesson.className.toLowerCase().includes(searchText)) ||
                                    (lesson.teacherName && lesson.teacherName.toLowerCase().includes(searchText));
                    
                    const schoolMatch = selectedSchool === '' || lesson.schoolName === selectedSchool;
                    const teacherMatch = selectedTeacher === '' || (lesson.teacherName && lesson.teacherName.trim() === selectedTeacher.trim());

                    return textMatch && schoolMatch && teacherMatch;
                });
                displayLessons(filteredLessons);
            };

            filterText.addEventListener('input', filterLessons);
            filterSchool.addEventListener('change', filterLessons);
            filterTeacher.addEventListener('change', filterLessons);
        }

        function displayLessons(lessons) {
            const lessonsTableBody = document.getElementById('lessons-table-body');
            if (!lessonsTableBody) return;
            lessonsTableBody.innerHTML = '';

            if (lessons.length === 0) {
                lessonsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhuma aula encontrada.</td></tr>';
                return;
            }

            lessons.forEach(lesson => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="whitespace-nowrap">${lesson.schoolName}</td>
                    <td class="whitespace-nowrap">${lesson.shift}</td>
                    <td class="whitespace-nowrap">${lesson.className}</td>
                    <td class="whitespace-nowrap">${lesson.numLessons}</td>
                    <td class="whitespace-nowrap">${lesson.teacherName || '<span class="text-red-500">Nenhum</span>'}</td>
                    <td class="whitespace-nowrap">
                        <div class="flex space-x-2">
                            <button class="edit-btn btn btn-secondary text-sm" data-id="${lesson.id}">Editar</button>
                            <button class="delete-btn btn bg-red-500 text-white text-sm" data-id="${lesson.id}">Excluir</button>
                        </div>
                    </td>
                `;
                lessonsTableBody.appendChild(row);
            });
        }
        
        // ------------------ Funções para a Gestão de Escolas ------------------
        let currentEditingSchoolId = null;

        function renderSchoolsView() {
            contentViews.innerHTML = `
                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Adicionar/Editar Escola</h2>
                    <form id="school-form" class="space-y-4">
                        <div>
                            <label for="school-name" class="block text-sm font-medium text-gray-700">Nome da Escola</label>
                            <input type="text" id="school-name" name="school-name" class="input-field mt-1" placeholder="Ex: E.M. Tonico Corredeira" required>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" id="submit-school-btn" class="btn btn-primary w-full">Adicionar Escola</button>
                            <button type="button" id="cancel-school-edit-btn" class="btn btn-secondary w-full hidden">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Escolas Cadastradas</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3">Escola</th>
                                    <th class="py-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="schools-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            setupSchoolsListeners();
            displaySchools(allSchools);
        }

        function setupSchoolsListeners() {
            const schoolForm = document.getElementById('school-form');
            const submitBtn = document.getElementById('submit-school-btn');
            const cancelEditBtn = document.getElementById('cancel-school-edit-btn');
            const schoolsTableBody = document.getElementById('schools-table-body');
            
            if (!schoolForm || !schoolsTableBody) return;

            schoolForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db || !isAuthReady) {
                    showMessage('O sistema não está pronto. Tente novamente em alguns segundos.', 'error');
                    return;
                }
                if (!canEdit) {
                    showMessage('Você não tem permissão para adicionar/editar itens.', 'error');
                    return;
                }
                const schoolName = document.getElementById('school-name').value;
                const schoolData = { name: schoolName };

                try {
                    if (currentEditingSchoolId) {
                        const schoolRef = doc(db, collections.schools, currentEditingSchoolId);
                        await updateDoc(schoolRef, schoolData);
                        showMessage('Escola atualizada com sucesso!', 'success');
                    } else {
                        await addDoc(collection(db, collections.schools), schoolData);
                        showMessage('Escola adicionada com sucesso!', 'success');
                    }
                    schoolForm.reset();
                    currentEditingSchoolId = null;
                    submitBtn.textContent = 'Adicionar Escola';
                    cancelEditBtn.classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao salvar escola: ", error);
                    showMessage('Erro ao salvar escola. Tente novamente.', 'error');
                }
            });

            cancelEditBtn.addEventListener('click', () => {
                schoolForm.reset();
                currentEditingSchoolId = null;
                submitBtn.textContent = 'Adicionar Escola';
                cancelEditBtn.classList.add('hidden');
            });

            schoolsTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const schoolId = e.target.dataset.id;
                    const school = allSchools.find(s => s.id === schoolId);
                    if (school) {
                        document.getElementById('school-name').value = school.name;
                        currentEditingSchoolId = schoolId;
                        submitBtn.textContent = 'Salvar Alterações';
                        cancelEditBtn.classList.remove('hidden');
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    const schoolId = e.target.dataset.id;
                    showConfirmModal('Tem certeza que deseja excluir esta escola? Esta ação não pode ser desfeita.', {
                        collectionName: collections.schools,
                        docId: schoolId
                    });
                }
            });
        }

        function displaySchools(schools) {
            const schoolsTableBody = document.getElementById('schools-table-body');
            if (!schoolsTableBody) return;
            schoolsTableBody.innerHTML = '';
            if (schools.length === 0) {
                schoolsTableBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhuma escola encontrada.</td></tr>';
            }
            schools.forEach(school => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.name}</td>
                    <td>
                        <button class="edit-btn btn btn-secondary text-sm" data-id="${school.id}">Editar</button>
                        <button class="delete-btn btn bg-red-500 text-white text-sm" data-id="${school.id}">Excluir</button>
                    </td>
                `;
                schoolsTableBody.appendChild(row);
            });
        }
        
        // ------------------ Funções para a Gestão de Professores ------------------
        let currentEditingTeacherId = null;

        function renderTeachersView() {
            contentViews.innerHTML = `
                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Adicionar/Editar Professor</h2>
                    <form id="teacher-form" class="space-y-4">
                        <div>
                            <label for="teacher-name" class="block text-sm font-medium text-gray-700">Nome do Professor</label>
                            <input type="text" id="teacher-name" name="teacher-name" class="input-field mt-1" placeholder="Ex: João da Silva" required>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" id="submit-teacher-btn" class="btn btn-primary w-full">Adicionar Professor</button>
                            <button type="button" id="cancel-teacher-edit-btn" class="btn btn-secondary w-full hidden">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Professores Cadastrados</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3">Professor</th>
                                    <th class="py-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="teachers-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            setupTeachersListeners();
            displayTeachers(allTeachers);
        }

        function setupTeachersListeners() {
            const teacherForm = document.getElementById('teacher-form');
            const submitBtn = document.getElementById('submit-teacher-btn');
            const cancelEditBtn = document.getElementById('cancel-teacher-edit-btn');
            const teachersTableBody = document.getElementById('teachers-table-body');
            
            if (!teacherForm || !teachersTableBody) return;

            teacherForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db || !isAuthReady) {
                    showMessage('O sistema não está pronto. Tente novamente em alguns segundos.', 'error');
                    return;
                }
                if (!canEdit) {
                    showMessage('Você não tem permissão para adicionar/editar itens.', 'error');
                    return;
                }
                const teacherName = document.getElementById('teacher-name').value;
                const teacherData = { name: teacherName };

                try {
                    if (currentEditingTeacherId) {
                        const teacherRef = doc(db, collections.teachers, currentEditingTeacherId);
                        await updateDoc(teacherRef, teacherData);
                        showMessage('Professor atualizado com sucesso!', 'success');
                    } else {
                        await addDoc(collection(db, collections.teachers), teacherData);
                        showMessage('Professor adicionado com sucesso!', 'success');
                    }
                    teacherForm.reset();
                    currentEditingTeacherId = null;
                    submitBtn.textContent = 'Adicionar Professor';
                    cancelEditBtn.classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao salvar professor: ", error);
                    showMessage('Erro ao salvar professor. Tente novamente.', 'error');
                }
            });

            cancelEditBtn.addEventListener('click', () => {
                teacherForm.reset();
                currentEditingTeacherId = null;
                submitBtn.textContent = 'Adicionar Professor';
                cancelEditBtn.classList.add('hidden');
            });

            teachersTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const teacherId = e.target.dataset.id;
                    const teacher = allTeachers.find(t => t.id === teacherId);
                    if (teacher) {
                        document.getElementById('teacher-name').value = teacher.name;
                        currentEditingTeacherId = teacherId;
                        submitBtn.textContent = 'Salvar Alterações';
                        cancelEditBtn.classList.remove('hidden');
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    const teacherId = e.target.dataset.id;
                    showConfirmModal('Tem certeza que deseja excluir este professor? Esta ação não pode ser desfeita.', {
                        collectionName: collections.teachers,
                        docId: teacherId
                    });
                }
            });
        }

        function displayTeachers(teachers) {
            const teachersTableBody = document.getElementById('teachers-table-body');
            if (!teachersTableBody) return;
            teachersTableBody.innerHTML = '';
            if (teachers.length === 0) {
                teachersTableBody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhum professor encontrado.</td></tr>';
            }
            teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.name}</td>
                    <td>
                        <button class="edit-btn btn btn-secondary text-sm" data-id="${teacher.id}">Editar</button>
                        <button class="delete-btn btn bg-red-500 text-white text-sm" data-id="${teacher.id}">Excluir</button>
                    </td>
                `;
                teachersTableBody.appendChild(row);
            });
        }

        // ------------------ Funções para Relatórios ------------------
        function renderReportsView() {
            contentViews.innerHTML = `
                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Aulas Sem Professor</h2>
                    <p class="text-gray-600 mb-4">Lista de todas as aulas que ainda não têm um professor atribuído. Priorize a alocação de docentes para estas turmas.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3">Escola</th>
                                    <th class="py-3">Turno</th>
                                    <th class="py-3">Turma</th>
                                    <th class="py-3">Nº Aulas</th>
                                </tr>
                            </thead>
                            <tbody id="unassigned-lessons-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Carga Horária por Professor</h2>
                    <p class="text-gray-600 mb-4">Visualize a carga horária total de cada professor para identificar sobrecargas ou subutilização.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3">Professor</th>
                                    <th class="py-3">Aulas Totais</th>
                                </tr>
                            </thead>
                            <tbody id="teacher-workload-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Distribuição de Aulas por Escola</h2>
                    <p class="text-gray-600 mb-4">Análise da quantidade de aulas atribuídas a cada escola.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="py-3">Escola</th>
                                    <th class="py-3">Total de Aulas</th>
                                    <th class="py-3">Aulas com Professor</th>
                                    <th class="py-3">Aulas sem Professor</th>
                                </tr>
                            </thead>
                            <tbody id="school-distribution-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-8 flex justify-end space-x-4">
                    <button id="export-excel-btn" class="btn btn-secondary">Exportar para Excel (Simulado)</button>
                    <button id="export-pdf-btn" class="btn btn-secondary">Exportar para PDF (Simulado)</button>
                </div>
            `;
            populateReports();
            document.getElementById('export-excel-btn').addEventListener('click', () => {
                showMessage('Exportação para Excel simulada. Em uma aplicação real, um arquivo seria gerado aqui.', 'info');
            });
            document.getElementById('export-pdf-btn').addEventListener('click', () => {
                showMessage('Exportação para PDF simulada. Em uma aplicação real, um arquivo seria gerado aqui.', 'info');
            });
        }

        function populateReports() {
            // Relatório de Aulas Sem Professor
            const unassignedLessonsTable = document.getElementById('unassigned-lessons-table-body');
            const unassignedLessons = allLessons.filter(lesson => !lesson.teacherName || lesson.teacherName.trim() === "");
            if (unassignedLessonsTable) {
              unassignedLessonsTable.innerHTML = '';
              if (unassignedLessons.length === 0) {
                  unassignedLessonsTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Todas as aulas têm professor atribuído! 🎉</td></tr>';
              } else {
                  unassignedLessons.forEach(lesson => {
                      const row = document.createElement('tr');
                      row.innerHTML = `
                          <td>${lesson.schoolName}</td>
                          <td>${lesson.shift}</td>
                          <td>${lesson.className}</td>
                          <td>${lesson.numLessons}</td>
                      `;
                      unassignedLessonsTable.appendChild(row);
                  });
              }
            }


            // Relatório de Carga Horária por Professor
            const teacherWorkloadTable = document.getElementById('teacher-workload-table-body');
            const teacherWorkload = allLessons.reduce((acc, lesson) => {
                if (lesson.teacherName && lesson.teacherName.trim() !== "") {
                    const name = lesson.teacherName.trim();
                    acc[name] = (acc[name] || 0) + lesson.numLessons;
                }
                return acc;
            }, {});
            if (teacherWorkloadTable) {
              teacherWorkloadTable.innerHTML = '';
              const sortedTeachers = Object.keys(teacherWorkload).sort((a, b) => teacherWorkload[b] - teacherWorkload[a]);
              if (sortedTeachers.length === 0) {
                  teacherWorkloadTable.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-gray-500">Nenhum professor com aulas atribuídas.</td></tr>';
              } else {
                  sortedTeachers.forEach(teacher => {
                      const row = document.createElement('tr');
                      row.innerHTML = `
                          <td>${teacher}</td>
                          <td>${teacherWorkload[teacher]}</td>
                      `;
                      teacherWorkloadTable.appendChild(row);
                  });
              }
            }


            // Relatório de Distribuição de Aulas por Escola
            const schoolDistributionTable = document.getElementById('school-distribution-table-body');
            const schoolDistribution = allLessons.reduce((acc, lesson) => {
                const school = lesson.schoolName;
                if (!acc[school]) {
                    acc[school] = { total: 0, assigned: 0, unassigned: 0 };
                }
                acc[school].total += lesson.numLessons;
                if (lesson.teacherName && lesson.teacherName.trim() !== "") {
                    acc[school].assigned += lesson.numLessons;
                } else {
                    acc[school].unassigned += lesson.numLessons;
                }
                return acc;
            }, {});
            if (schoolDistributionTable) {
              schoolDistributionTable.innerHTML = '';
              const sortedSchools = Object.keys(schoolDistribution).sort();
              if (sortedSchools.length === 0) {
                  schoolDistributionTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma escola com aulas cadastradas.</td></tr>';
              } else {
                  sortedSchools.forEach(school => {
                      const row = document.createElement('tr');
                      row.innerHTML = `
                          <td>${school}</td>
                          <td>${schoolDistribution[school].total}</td>
                          <td>${schoolDistribution[school].assigned}</td>
                          <td class="font-bold text-red-500">${schoolDistribution[school].unassigned}</td>
                      `;
                      schoolDistributionTable.appendChild(row);
                  });
              }
            }
        }

        // ------------------ Funções de Importação de Dados ------------------
        function renderImportView() {
            contentViews.innerHTML = `
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Importar Dados de Planilha (CSV)</h2>
                    <p class="text-gray-600 mb-4">Selecione um arquivo CSV com o mesmo formato da sua planilha para importar os dados para o sistema.</p>
                    <div class="space-y-4">
                        <input type="file" id="csv-file-input" accept=".csv" class="input-field mt-1">
                        <button id="import-btn" class="btn btn-primary w-full" disabled>Importar Dados</button>
                    </div>
                    <div id="import-status" class="mt-4 text-sm text-gray-700"></div>
                </div>
            `;
            const fileInput = document.getElementById('csv-file-input');
            const importBtn = document.getElementById('import-btn');

            if (!fileInput || !importBtn) return;

            fileInput.addEventListener('change', () => {
                importBtn.disabled = !fileInput.files[0];
            });

            importBtn.addEventListener('click', importCsvData);
        }

        async function importCsvData() {
            if (!db || !isAuthReady) {
                showMessage('O sistema não está pronto. Tente novamente em alguns segundos.', 'error');
                return;
            }
            if (!canEdit) {
                showMessage('Você não tem permissão para importar dados.', 'error');
                return;
            }
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Por favor, selecione um arquivo CSV para importar.', 'error');
                return;
            }

            document.getElementById('import-status').textContent = 'Importando dados... Isso pode levar alguns segundos.';
            const importBtn = document.getElementById('import-btn');
            importBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(header => header.trim());

                // Verifica se os cabeçalhos estão corretos
                const requiredHeaders = ['Escola', 'Turno', 'Turma', 'Nº Aulas', 'Professor'];
                const headersMatch = requiredHeaders.every(h => headers.includes(h));

                if (!headersMatch) {
                    showMessage('O arquivo CSV não possui as colunas necessárias: Escola, Turno, Turma, Nº Aulas, Professor.', 'error');
                    importBtn.disabled = false;
                    return;
                }

                const allItems = lines.slice(1).map(line => {
                    const values = line.split(',');
                    if (values.length !== headers.length) return null;
                    const item = {};
                    headers.forEach((header, i) => {
                        item[header] = values[i] ? values[i].trim() : '';
                    });
                    return item;
                }).filter(item => item !== null && item['Escola'] && item['Turno'] && item['Turma']); // Filtra linhas inválidas

                let importedCount = 0;
                let importErrors = 0;
                let teachersToImport = new Set();
                let schoolsToImport = new Set();
                
                allItems.forEach(item => {
                    schoolsToImport.add(item['Escola']);
                    if (item['Professor'] && item['Professor'].trim() !== '') {
                        teachersToImport.add(item['Professor']);
                    }
                });

                // Importar escolas
                for (const schoolName of schoolsToImport) {
                    try {
                        await addDoc(collection(db, collections.schools), { name: schoolName });
                    } catch(e) { console.error("Erro ao importar escola:", e); }
                }

                // Importar professores
                for (const teacherName of teachersToImport) {
                    try {
                        await addDoc(collection(db, collections.teachers), { name: teacherName });
                    } catch(e) { console.error("Erro ao importar professor:", e); }
                }

                // Importar aulas
                for (const item of allItems) {
                    try {
                        const lessonData = {
                            schoolName: item['Escola'],
                            shift: item['Turno'],
                            className: item['Turma'],
                            numLessons: parseInt(item['Nº Aulas'] || 1), // Garante que é um número
                            teacherName: item['Professor'] || '',
                            lessonTime: '',
                        };
                        await addDoc(collection(db, collections.lessons), lessonData);
                        importedCount++;
                    } catch (e) {
                        console.error("Erro ao importar item:", e);
                        importErrors++;
                    }
                }

                showMessage(`Importação concluída. ${importedCount} aulas importadas com sucesso. ${importErrors} erros.`, 'success');
                document.getElementById('import-status').textContent = '';
                importBtn.disabled = false;
                fileInput.value = ''; // Limpa o campo de arquivo
            };
            reader.readAsText(file);
        }

        // ------------------ Listeners em Tempo Real do Firestore ------------------
        async function setupRealtimeListeners() {
            // Verifica se o db e a autenticação estão prontos
            if (!db || !isAuthReady) {
              console.log("Database ou autenticação não estão prontos. Tentando novamente em 1s.");
              setTimeout(setupRealtimeListeners, 1000);
              return;
            }

            // Listener para aulas
            onSnapshot(collection(db, collections.lessons), (snapshot) => {
                const lessons = [];
                snapshot.forEach(doc => {
                    lessons.push({ id: doc.id, ...doc.data() });
                });
                allLessons = lessons;
                updateDashboard();
                const currentView = document.querySelector('.nav-item.active')?.dataset.view;
                if (currentView === 'manage-lessons') {
                    displayLessons(lessons);
                    populateLessonsFormOptions();
                } else if (currentView === 'reports') {
                    populateReports();
                }
            });

            // Listener para professores
            onSnapshot(collection(db, collections.teachers), (snapshot) => {
                 const teachers = [];
                 snapshot.forEach(doc => teachers.push({ id: doc.id, ...doc.data() }));
                 allTeachers = teachers;
                 updateDashboard();
                 const currentView = document.querySelector('.nav-item.active')?.dataset.view;
                 if (currentView === 'manage-lessons') {
                    populateLessonsFormOptions();
                 } else if (currentView === 'manage-teachers') {
                    displayTeachers(allTeachers);
                 } else if (currentView === 'reports') {
                    populateReports();
                 }
            });

            // Listener para escolas
            onSnapshot(collection(db, collections.schools), (snapshot) => {
                const schools = [];
                snapshot.forEach(doc => schools.push({ id: doc.id, ...doc.data() }));
                allSchools = schools;
                updateDashboard();
                const currentView = document.querySelector('.nav-item.active')?.dataset.view;
                if (currentView === 'manage-lessons') {
                    populateLessonsFormOptions();
                } else if (currentView === 'manage-schools') {
                    displaySchools(allSchools);
                } else if (currentView === 'reports') {
                    populateReports();
                 }
            });
        }

        // Inicia a aplicação
        window.onload = () => {
            document.getElementById('loading-message').classList.remove('hidden');
            initializeFirebase();
        };
    </script>
</body>
</html>
